# Changelog

## [2.27.2] - 2026-02-27
### 🐛 关键修复
- **修复设备扫描失败**：在 server.js 中新增 `/ha-api` 反向代理路由，将前端 REST 请求（如 `fetchStatesRest`）正确转发到 HA Core（`http://supervisor/core`）。此前生产环境中 `/ha-api` 请求直接被 fallback 返回 `index.html`，导致"扫描失败，请检查连接"。
- **修复连接验证一直显示灰色感叹号**：原 `useEffect` 仅在 `token` 值变化时触发，打开设置界面时 token 已存在但不变化导致不触发验证。新增打开模态框时立即验证逻辑；验证同时支持 HA Ingress 代理（`/ha-api`）和用户配置的直连地址两种方式。

## [2.27.1] - 2026-02-27
### 🔧 代码质量修复
- 清理 `SettingsModal.tsx` 中所有未使用的导入（8 个 lucide 图标、`HassEntities`、`createOneOffConnection` 等）
- 将弃用的 `verifyConnection` 独立函数重构为 `useEffect` 自动验证，token 输入后 1 秒防抖自动触发连接检查，恢复验证状态 UI 完整功能

## [2.27.0] - 2026-02-27
### ✨ 新增功能
- **人员头像本地上传**：人员管理页面支持上传本地图片作为头像（限制 2MB），悬浮头像即可触发上传；支持随时清除自定义头像并恢复 Home Assistant 同步头像。
- **手动添加人员**：无需 HA 连接也可在人员管理中手动新增成员，支持直接编辑姓名。

### 🐛 缺陷修复
- **修复萤石云摄像头无法播放**：HA Ingress 部署环境下，浏览器直连萤石 API 会被 CSP 安全策略拦截，导致获取 Token 和流地址失败。已改为通过插件内置 Node.js 服务端代理转发萤石请求，彻底解决播放问题。本地开发模式下自动降级为直连方式。
- **修复萤石云参数传递错误**：服务端代理补全了 `protocol`（HLS/FLV协议选择）、`validateCode`（加密摄像头验证码）、`expireTime` 等关键参数，确保配置的协议类型生效。
- **提升多端配置同步稳定性**：HA 插件刚启动时 Express 服务可能未就绪，初始配置拉取超时由 4 秒提升至 8 秒，并新增最多 3 次自动重试；服务端 Body 大小限制从 10MB 提升至 20MB，支持多张 Base64 头像同步不被截断。


## [1.0.5] - 2026-02-23
### 🔧 关键修复 (Critical Fix)
- **正式修复跨设备配置不同步**：重写了前端同步引擎和后端服务端代码。新版本能正确识别 HA Ingress 代理的子路径前缀，确保 `/api/storage` 接口在 Ingress 环境下被正确路由到容器内部，而不会被 HA 层面的认证代理拦截或返回 HTML 导致静默失败。现在无论用任何设备、任何浏览器打开 HAUI，令牌与配置均自动同步。

## [1.0.4] - 2026-02-23
### 🐛 缺陷修复 (Bug Fixes)
- 紧急修复了云同步服务端因为 Express 5.x 核心依赖版本导致的正则表达式匹配报错而无法启动（绿屏/白屏启动崩溃）的问题。
- 修复了加载项内部网关默认 80 端口造成的权限拒绝故障，优化端口为 8099 工作模式以保证全平台启动成功率。

## [1.0.3] - 2026-02-23
### ✨ 新增功能 (Features)
- **多设备跨端云同步**：重写了底层架构设施，剥离静态服务而全新引入 Node.js 本地微服务中心。从此之后您的令牌(Token)、自定义界面卡片排版、设备按键映射等高级配置将脱离单纯的浏览器缓存限制。无论您是用手机、平板还是新的电脑打开面板，都能在一瞬间全自动下载同步您之前的心血配置，做到随时随地体验如一！

### 🐛 缺陷修复 (Bug Fixes)
- 修复了更换浏览器/新设备打开时配置和授权状态变空白的问题。

---
## [1.0.2]
### ✨ 新增功能 (Features)
- 系统底层进行了深度代码清理与瘦身。
- 加载项介绍文档完成了全盘深度中文化，并配置了极客风格的霓虹科技专属图标 `haui_addon_icon`。
